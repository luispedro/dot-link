\documentclass[a4paper,10pt]{article}
\usepackage[boxruled,vlined,portugues,figure,linesnumbered,longend]{algorithm2e}


\newcommand*{\Assign}{\ensuremath\longleftarrow}
\newcommand{\putstring}[1]{\textsl{#1}}
\newtheorem{definition}{Definition}


\title{Dotted Suffix Trees\\A Structure for Approximate Text Indexing}
\author{L. P. Coelho \and A. Oliveira}

\begin{document}

\maketitle

\begin{abstract}

\end{abstract}

\section{Introduction}



\subsection{Related Work}
\subsection{Structure of the Paper}

In section~\ref{sec:structure} we present the structure and the way to use it for searching. In section~\ref{sec:build-1} we show the way to build a structure to handle one error only and analize this version of the algorithm. Then, we show, in section~\ref{sec:build-k} how to generalize this procedure for any number of errors and how the previous analisys also applies to any number of errors.

\section{The Indexing Structure}

\subsection{Intuition}
Suffix Trees have become a well known structure since their introduction in 1973~\cite{weiner}. In Figure~\ref{fig:suffix-0} we show the suffix tree for the string \putstring{mississipi}.

We add to each internal node in the structure a new link, which we call the \emph{error link}. 

\subsection{Formal definition}

\begin{definition}[Character, string]
Given a set $\Sigma$, we say that $s$ is a \emph{string over $\Sigma$} if $s$ is a possibly empty sequence of elements of $\Sigma$. The elements of the set $\Sigma$ are also called \emph{character}. The lenght of the string, denoted by $|s|$ is the number of elements it contains. We shall write $s_i$ for the $i$th element of the string. For the empty string, we write $\epsilon$.

The set of all string is denoted by $\Sigma^*$ and $\Sigma^+=\Sigma^*-\{\epsilon\}$.
\end{definition}

For denoting character we shall use letters from the begginning of the roman alphabet ($a$, $b$, $c$,\ldots) and for strings, we shall use letters from the end of the alphabet ($w$, $z$, \ldots).

\begin{definition}
$wx$ will denote the string formed by all the character of $w$ followed by all the characters of $x$ (the usual concatenation operation). $aw$ ($wa$) shall the denote the strings by the caracter $a$ before (after) the characters of $w$.

If $s = wxy$, then $w$ is a \emph{prefix} of $s$, $x$ is a \emph{substring} of $s$ (at position $s$) and $y$ is a \emph{suffix} of $s$ (at position $p$).
\end{definition}

\begin{definition}[$\Sigma^+$ tree]
$T$ is a $\Sigma^+$ tree if $T$ is a rooted tree with edge labels from $\Sigma^+$. For each $a \in \Sigma$ and every node $n$ in $T$, there is at most an edge leaving $n$ whose label is $aw$.

$\Sigma^+$ trees are also called a PATRICIA trees~\cite{pat}.

Each node in a $\Sigma^+$ tree has a path leading to it which forms a string. If the node $n$ has the leading path $w$, we shall also refer to $n$ as $\overline{w}$.
\end{definition}

In what follows we will assume that there are two symbols (\$ and $.$) which are not part of $\Sigma$.

\begin{definition}[Aproximate Match]
We say that the string $s$ matches the string $t$ at position $p$ with $k$ errors if we can make $k$ substitutions in $s$ such that $s$ is a substring of $t$ at position $p$.
\end{definition}

\begin{definition}[Pattern]
A pattern is a string over the extended alphabet $\Sigma\cup\{.\}$. We say that a pattern $s$ matches a string $t$ at position $p$, if for each dot in the pattern we can replace it by a character in the original alphabet to obtain $s'$ which is a substring of $t$ at position $p$.
\end{definition}

\begin{definition}[Suffix Tree]
A \emph{suffix tree} for a string $S$ is a $\Sigma^+$ whose leaf nodes (those without children) have paths corresponding to suffixes of the string $S\$ $.
\end{definition}

\begin{definition}[Occurence Set]
Given a node $\overline{w}$ in a suffix tree, we call it's \emph{occurence set} the set of indexes in the original string where the string $w$ occurs.
\end{definition}

\begin{definition}{Position Set}
Given a node $\overline{w}$ in a suffix tree, it's \emph{position set} is the set formed by taking it's occurence set and adding the lenght of $w$ to each element.
\end{definition}

For example, in the node \overline{issi} in the suffix tree of Figure~\ref{fig:mississipi-0}, the occurence set is $\{5, 2\}$ and its position set is $\{6, 9\}$. In a sense, one can say that being at node \overline{issi} is being at positions 6 and~9 simultaneously. Note that for each node, the tree below it is the $\Sigma^+$ tree of the suffixes starting at the positions in its position set.

In a leaf, the position set is a singleton, and we label the leaf by its element.

\begin{definition}[Error Tree]
For any node $w$ its error tree is the $\Sigma^+$ tree formed by taking it's position set, adding one to each element and forming the $\Sigma^+$ tree of the suffixes of the suffixes starting at those positions. If the position set includes the end of the string, that element is removed.

The leafs are labeled by the position of the string in which their paths occur minus $|w| + 1$.
\end{definition}

For example, in the above mentioned node \overline{issi}, the error tree is formed by taking the strings starting at positions $\{7, 10\}$ (ie \putstring{sipi\$} and \putstring{i\$}) in a $\Sigma^+$ tree.

\begin{definition}[1-error dotted Tree]
We define a \emph{1-error dotted tree} as the tree which add to each node in a suffix tree, a new edge labeled by \putstring{.} which points to its error tree. The edge labeled \putstring{.} shall be called a \emph{dot link}.
\end{definition}

The one-error dotted tree for \putstring{mississipi} is shown in Figure~\ref{fig:mississipi-1}.

The paths in the dotted tree are paths in the extended alphabet $\Sigma\cup\{.,\$\}$. The notions of \emph{occurence set}, \emph{position set} and \emph{error tree} are valid for all nodes in a dotted tree considering that a node path may contain dot elements which match any other character.

\begin{definition}[k-error dotted tree]
We define a k-error dotted tree as the tree obtained by adding error trees to each node in the (k-1)-error dotted tree.
\end{definition}

\subsection{Space Considerations}

How much space does a k-error dotted tree take? Suffix Trees have a number of nodes proportional to the size of the string (which we will refer to as $n$). One-error dotted trees have more nodes. The worst case presented in Figure~\ref{fig:aaaa} is a string of the form \putstring{aa\ldots{}aa} which generates a one-dotted tree taking $O(n^2)$ nodes. For a larger number of errors $k$, it is easy to see that this leads to $O(n^{k+1})$ nodes.

We will reason by induction, starting with the case of a one-error dotted tree to show that this bound can also be expressed as $O(nh^k)$ where $h$ is the average height of the tree (number of nodes between the root and the leaf).

The number of nodes in a Patricia tree is $2n-1$~\cite{patricia} (as a special case, a suffix tree is the Patricia tree of all the suffixes in a string). The number of nodes in the error tree of a node is therefore bounded by double the number of leafs in the subtree at that node.

We define $L(w)$ as the number of leafs in the subtree rooted at $n$. The total number of nodes for all the error trees in the dotted tree is therefore equal to $\Sum_{w \in \mathcal{T}}L(n)$ where $\mathcal{T}$ is the original suffix tree. It is a general property of trees that, for any tree $\mathcal{T}$, $\Sum_{w \in \mathcal{T}}L(w) = O(nh)$~\cite{whatever}.

We also remark that at each node, the error tree cannot be deeper than the subtree rooted at that node. Therefore the average height of the tree is preserved. FIXME: show this

For the (k+1)-error tree, we need to add error trees to each node in the k-error tree (which we assume inductively to have $O(nh^k)$ nodes). Each of these error trees will have $O(L(w))$ nodes. Again, given that the k-error tree has height $h$, we have $O(nh^{k+1})$ nodes as desired.

Sofar, we have not really obtained much since, in the worst case, $h=O(n)$. However, the average expected case, is $h=O(\log n)$~\cite{devroye:note,szpankowski:unexpected}.

\subsection{Searching}

To search a string with at maximum k errors in a k-error dotted tree, we need to descend the tree. Whenever we find a node we follow both the dot link and the edge which matches the current position of the string we are searching. If we have a mismatch in the middle of an edge, we continue, decreasing the amount of errors permitted.

\input{search-algo}

The search algorithm is presented in Figure~\ref{algo:search}. We have taken the liberty of using $s+j$ where $s$ is a string and $j$ an integer to mean the suffix of $s$ starting at $j$. Reporting of the leafs below a certain node can be done by a simple Depth First Search reporting any leafs found. If one is interested in knowing only whether the string occurs, then the lines which report the matches can be substituted by simple early exist returning true.


\section{Constructing the Dotted Tree}

\subsection{One-Error Dotted Tree}



\bibliographystyle{alpha}
\bibliography{biblio}
\end{document}
